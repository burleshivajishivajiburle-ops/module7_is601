name: Build and Test Docker Image

on:
  push:
    branches: [ master ]

permissions:
  contents: read
  packages: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ghcr.io/${{ github.repository_owner }}/qr_codemaker:latest
        
    - name: Test Docker image
      run: |
        mkdir -p qr_codes
        chmod 777 qr_codes
        docker run --rm -v $(pwd)/qr_codes:/app/qr_codes ghcr.io/${{ github.repository_owner }}/qr_codemaker:latest --url https://github.com/burleshivajishivajiburle-ops
        echo "Container test completed"
        
    - name: Verify QR code generation
      run: |
        sleep 2
        ls -la qr_codes/ || echo "Directory check"
        if [ "$(ls -A qr_codes/ 2>/dev/null)" ]; then
          echo " QR code generation successful!"
          ls -la qr_codes/
        else
          echo " No QR code generated!"
          exit 1
        fi
        
    - name: Test Docker Compose
      run: |
        rm -rf qr_codes/*.png || true
        mkdir -p qr_codes
        chmod 777 qr_codes
        docker compose up --build --abort-on-container-exit
        echo "Docker Compose test completed"
        
    - name: Verify Docker Compose result
      run: |
        sleep 2
        ls -la qr_codes/ || echo "Directory check"
        if [ "$(ls -A qr_codes/ 2>/dev/null)" ]; then
          echo "âœ… Docker Compose successful!"
          ls -la qr_codes/
        else
          echo "âŒ Docker Compose failed!"
          exit 1
        fi
        
    - name: Assignment Complete
      run: |
        echo "ğŸ‰ Assignment completed successfully!"
        echo "âœ… Docker image built and pushed to GHCR"
        echo "âœ… QR code generation verified"
        echo "âœ… Docker Compose working"
        echo "âœ… Container logs show successful execution"